# File Modification Safety Rules

**Purpose**: Define which files are safe to modify vs read-only auto-generated files.

## File Classification Matrix

| File Type | Location Pattern | Modification Rule | Update Method |
|-----------|------------------|-------------------|---------------|
| **query-competency-index.md** | `~/reference/` | ❌ READ-ONLY | Run `select_collection.py` |
| **olaf-framework-condensed.md** | `~/reference/.condensed/` | ❌ READ-ONLY | Run condense-olaf-framework |
| **competency-manifest.json** | `competencies/*/` | ✅ MODIFIABLE | Direct edit |
| **skill-manifest.json** (existing) | `skills/*/` | ✅ MODIFIABLE | Direct edit |
| **skill-manifest.json** (new) | Creating new skill | ✅ MODIFIABLE | Generate new file |
| **Any file in new skill dir** | `skills/[new-skill]/` | ✅ MODIFIABLE | Create new files |
| **Files with AUTO-GENERATED marker** | Any location | ❌ READ-ONLY | Check file header |

## Auto-Generated File Detection

### Header Markers

Check file headers for these markers indicating auto-generated content:

```markdown
<!-- AUTO-GENERATED - DO NOT EDIT -->
<!-- Generated by: [script-name] -->
<!-- Last generated: [timestamp] -->
```

```json
{
  "_meta": {
    "auto_generated": true,
    "generated_by": "script-name",
    "warning": "DO NOT EDIT - Changes will be overwritten"
  }
}
```

### Known Auto-Generated Files

**NEVER modify these files directly:**

1. **query-competency-index.md**
   - Location: `~/reference/query-competency-index.md`
   - Generated by: `select_collection.py`
   - Purpose: Competency-to-skill mapping index
   - Update: Run `python scripts/olaf-structure-management/select_collection.py --collection [name]`

2. **olaf-framework-condensed.md**
   - Location: `~/reference/.condensed/olaf-framework-condensed.md`
   - Generated by: `condense-olaf-framework` skill
   - Purpose: Condensed framework patterns
   - Update: Execute `condense-olaf-framework` competency

3. **Skills registry files** (if marked auto-generated)
   - Check individual files for markers
   - Some registries are manual, some auto-generated

## Safe Modification Protocols

### ✅ Safe to Modify - Direct Edit

**Competency Manifests:**
```json
// File: competencies/[competency-name]/competency-manifest.json
{
  "skills": [
    {
      "id": "new-skill",
      "path": "/skills/new-skill/prompts/new-skill.md",
      "description": "...",
      "patterns": ["create new", "build new"]
    }
  ]
}
```

You CAN directly edit this file to add skill references.

**New Skill Files:**
All files within newly created skill directory are safe to modify:
```
skills/new-skill/
├── skill-manifest.json      ✅ Safe - you're creating it
├── prompts/*.md             ✅ Safe - you're creating them
├── docs/*.md                ✅ Safe - you're creating them
└── [any other files]        ✅ Safe - you're creating them
```

### ❌ Read-Only - Script Required

**Competency Index:**
```markdown
<!-- AUTO-GENERATED - DO NOT EDIT -->
# Competency Index
Last Updated: 20251124-1622
Generated By: select_collection.py

## Mappings
[{"create skill", "new skill"}, "skills/create-skill/prompts/create-skill.md", "Propose-Confirm-Act"]
```

❌ DO NOT directly edit this file
✅ OFFER to run regeneration script instead

## Error Prevention Guidelines

### Before Modifying Any File

1. **Check file location** against classification matrix
2. **Read file header** for auto-generated markers
3. **If uncertain**, ask user before modifying
4. **If read-only**, offer script execution instead

### When User Requests Index Update

**WRONG Approach:**
```markdown
I'll update query-competency-index.md to add your new skill...
[Attempts to edit file directly]
```

**CORRECT Approach:**
```markdown
The query-competency-index.md is auto-generated and cannot be edited directly.

I've updated the competency manifest with your new skill.

To update the competency index, we need to regenerate it:
Ready to run: python scripts/olaf-structure-management/select_collection.py --collection [your-collection]? (yes/no)
```

## Script Execution Protocols

### Competency Index Regeneration

**When to offer:**
- After creating new skill
- After updating competency manifests
- When user requests index update

**How to execute:**
```powershell
python scripts/olaf-structure-management/select_collection.py --collection [collection-name]
```

**Default collection:**
- Script uses user's active collection if not specified
- Common collections: `all`, `olaf-base-skills`, `developer`, etc.

**Validation after execution:**
- Confirm script completed successfully
- Verify pattern markers intact in condensed framework
- Check new skill appears in query-competency-index.md

### Framework Condensation

**When to offer:**
- After major framework changes
- After adding multiple new competencies
- When framework feels out of sync

**How to execute:**
```
Execute the condense-olaf-framework competency
```

## Competency Assignment Process

### Step 1: Update Competency Manifest (Direct Edit - SAFE)

```json
// File: competencies/[target-competency]/competency-manifest.json
{
  "metadata": {
    "id": "developer",
    "name": "Developer Competency"
  },
  "skills": [
    // Existing skills...
    {
      "id": "new-skill-name",
      "path": "/skills/new-skill-name/prompts/new-skill-name.md",
      "description": "Brief description of what the skill does",
      "patterns": [
        "trigger phrase 1",
        "trigger phrase 2",
        "skill invocation pattern"
      ],
      "protocol": "Propose-Confirm-Act",
      "tags": ["tag1", "tag2"]
    }
  ]
}
```

✅ This is SAFE to modify directly - it's the source of truth.

### Step 2: Offer Index Regeneration (Script - READ-ONLY)

After updating competency manifest:

```markdown
✅ Skill assigned to [competency-name] competency!

The competency manifest has been updated.

Next step: Regenerate the competency index to make your skill discoverable?

This will run: select_collection.py --collection [collection]
Ready to proceed? (yes/no)
```

### Step 3: Execute If User Confirms

Only if user says "yes":
```powershell
python scripts/olaf-structure-management/select_collection.py --collection [user-collection]
```

## Error Messages

### When Attempting to Modify Read-Only File

```
❌ Cannot modify query-competency-index.md - this file is auto-generated.

Changes would be overwritten on next regeneration.

✅ Solution: Update the competency manifest instead, then regenerate the index.
Would you like me to:
1. Update the competency manifest (safe)
2. Run the regeneration script
```

### When Script Not Found

```
⚠️  Script not found: scripts/select_collection.py

Alternative paths to try:
- .olaf/scripts/select_collection.py
- scripts/olaf/select_collection.py

Or you can manually regenerate by running the select-competency-collection skill.
```

### When Script Execution Fails

```
❌ Script execution failed with error:
[Show error output]

Troubleshooting steps:
1. Check Python environment is activated
2. Verify all dependencies are installed
3. Check file permissions
4. Try running manually: python scripts/olaf-structure-management/select_collection.py --collection all
```

## Validation Checklist

Before completing skill creation:

- [ ] New skill directory created under `skills/`
- [ ] All new skill files created (safe to modify)
- [ ] Competency manifest updated with skill reference (safe to modify)
- [ ] User offered index regeneration (NOT direct file edit)
- [ ] If user confirmed, regeneration script executed
- [ ] No read-only files were directly modified
- [ ] All auto-generated files remain untouched

## Summary

**ALWAYS SAFE to modify:**
- New files you're creating
- Competency manifest JSON files
- Skill manifest JSON files
- Any file within a skill directory you're creating

**NEVER modify directly:**
- query-competency-index.md
- olaf-framework-condensed.md
- Files with AUTO-GENERATED markers

**When in doubt:**
- Check file header for markers
- Check classification matrix
- Offer script execution instead of direct edit
- Ask user for confirmation
